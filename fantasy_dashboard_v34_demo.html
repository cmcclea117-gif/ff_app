<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fantasy Football Dashboard V3.4 - Demo</title>
<style>
* {{
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}}

body {{
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
  color: #ecf0f1;
  min-height: 100vh;
  padding: 20px;
}}

.container {{
  max-width: 1800px;
  margin: 0 auto;
}}

h1 {{
  text-align: center;
  margin-bottom: 20px;
  font-size: 2.5em;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}}

/* Upload Section */
.upload-section {{
  background: rgba(255,255,255,0.1);
  border-radius: 15px;
  padding: 20px;
  margin-bottom: 20px;
  backdrop-filter: blur(10px);
}}

.upload-section h2 {{
  margin-bottom: 15px;
  font-size: 1.3em;
}}

.controls {{
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  align-items: center;
}}

.control-group {{
  display: flex;
  flex-direction: column;
  gap: 5px;
}}

.control-group label {{
  font-size: 0.9em;
  color: #bdc3c7;
}}

.control-group input,
.control-group select {{
  padding: 8px 12px;
  border: 2px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  background: rgba(255,255,255,0.1);
  color: #ecf0f1;
  font-size: 1em;
}}

.control-group input:focus,
.control-group select:focus {{
  outline: none;
  border-color: #3498db;
}}

button {{
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-size: 1em;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  font-weight: 600;
}}

button:hover {{
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}}

button:active {{
  transform: translateY(0);
}}

.status {{
  margin-top: 10px;
  padding: 10px;
  border-radius: 8px;
  font-size: 0.95em;
}}

.status.success {{
  background: rgba(46, 204, 113, 0.2);
  border: 1px solid #2ecc71;
}}

.status.error {{
  background: rgba(231, 76, 60, 0.2);
  border: 1px solid #e74c3c;
}}

/* Tab Navigation */
.tab-container {{
  background: rgba(255,255,255,0.05);
  border-radius: 15px;
  padding: 20px;
  backdrop-filter: blur(10px);
}}

.tab-nav {{
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}}

.tab-btn {{
  padding: 12px 24px;
  border: none;
  border-radius: 10px;
  background: rgba(255,255,255,0.1);
  color: #bdc3c7;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 600;
}}

.tab-btn:hover {{
  background: rgba(255,255,255,0.2);
  color: #ecf0f1;
}}

.tab-btn.active {{
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}}

.tab-content {{
  display: none;
}}

.tab-content.active {{
  display: block;
  animation: fadeIn 0.3s;
}}

@keyframes fadeIn {{
  from {{ opacity: 0; transform: translateY(10px); }}
  to {{ opacity: 1; transform: translateY(0); }}
}}

/* Stats Cards */
.stats-cards {{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}}

.stat-card {{
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 15px;
  text-align: center;
  border-left: 4px solid #3498db;
}}

.stat-card h3 {{
  font-size: 0.9em;
  color: #bdc3c7;
  margin-bottom: 5px;
}}

.stat-card .value {{
  font-size: 1.8em;
  font-weight: bold;
  color: #3498db;
}}

/* Filters */
.filters {{
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  align-items: center;
}}

.filter-group {{
  display: flex;
  flex-direction: column;
  gap: 5px;
}}

.filter-group label {{
  font-size: 0.9em;
  color: #bdc3c7;
}}

.filter-group select,
.filter-group input {{
  padding: 8px 12px;
  border: 2px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  background: rgba(255,255,255,0.1);
  color: #ecf0f1;
  font-size: 1em;
}}

/* Position Buttons */
.position-buttons {{
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}}

.pos-btn {{
  padding: 10px 20px;
  border: 2px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  background: rgba(255,255,255,0.1);
  color: #ecf0f1;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 600;
}}

.pos-btn:hover {{
  background: rgba(255,255,255,0.2);
}}

.pos-btn.active {{
  border-color: #3498db;
  background: rgba(52, 152, 219, 0.3);
  color: #3498db;
}}

/* Tables */
.table-container {{
  overflow-x: auto;
  border-radius: 10px;
  background: rgba(255,255,255,0.05);
}}

table {{
  width: 100%;
  border-collapse: collapse;
  min-width: 800px;
}}

thead {{
  background: rgba(255,255,255,0.1);
  position: sticky;
  top: 0;
  z-index: 10;
}}

th {{
  padding: 12px;
  text-align: left;
  font-weight: 600;
  color: #3498db;
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
}}

th:hover {{
  background: rgba(255,255,255,0.15);
}}

th.sortable::after {{
  content: ' ‚áÖ';
  color: #7f8c8d;
}}

th.sort-asc::after {{
  content: ' ‚Üë';
  color: #3498db;
}}

th.sort-desc::after {{
  content: ' ‚Üì';
  color: #3498db;
}}

td {{
  padding: 10px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}}

tbody tr {{
  transition: background 0.2s;
}}

tbody tr:hover {{
  background: rgba(255,255,255,0.1);
}}

/* Position Colors */
.pos-QB {{ border-left: 4px solid #e74c3c; }}
.pos-RB {{ border-left: 4px solid #2ecc71; }}
.pos-WR {{ border-left: 4px solid #3498db; }}
.pos-TE {{ border-left: 4px solid #f39c12; }}

/* Tier Badges */
.badge {{
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.85em;
  font-weight: 600;
  display: inline-block;
}}

.badge.elite {{
  background: #2ecc71;
  color: white;
}}

.badge.high {{
  background: #3498db;
  color: white;
}}

.badge.mid {{
  background: #f39c12;
  color: white;
}}

.badge.stream {{
  background: #95a5a6;
  color: white;
}}

/* Trend Indicators */
.trend-up {{ color: #2ecc71; }}
.trend-down {{ color: #e74c3c; }}
.trend-stable {{ color: #95a5a6; }}

/* Roster Highlight */
.rostered {{
  background: rgba(52, 152, 219, 0.15);
  font-weight: 600;
}}

.my-roster {{
  background: rgba(46, 204, 113, 0.15);
  font-weight: 600;
}}

/* Priority Icons */
.priority-hot {{ color: #e74c3c; font-size: 1.2em; }}
.priority-star {{ color: #f39c12; font-size: 1.2em; }}
.priority-watch {{ color: #95a5a6; font-size: 1.2em; }}

/* Lineup Optimizer */
.lineup-config {{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}}

.lineup-results {{
  margin-top: 20px;
}}

.starters-grid {{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}}

.starter-card {{
  background: rgba(46, 204, 113, 0.2);
  border: 2px solid #2ecc71;
  border-radius: 10px;
  padding: 15px;
}}

.starter-card h4 {{
  color: #2ecc71;
  margin-bottom: 10px;
}}

.bench-section {{
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  padding: 15px;
}}

.bench-section h3 {{
  margin-bottom: 10px;
  color: #95a5a6;
}}

.bench-list {{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 10px;
}}

/* Historical Tables */
.historical-section {{
  margin-bottom: 30px;
}}

.historical-section h3 {{
  margin-bottom: 15px;
  padding: 10px;
  background: rgba(255,255,255,0.1);
  border-radius: 8px;
  border-left: 4px solid #3498db;
}}

/* Responsive */
@media (max-width: 768px) {{
  h1 {{ font-size: 1.8em; }}
  .controls {{ flex-direction: column; }}
  .tab-nav {{ flex-direction: column; }}
  .filters {{ flex-direction: column; }}
  .stats-cards {{ grid-template-columns: 1fr; }}
}}
</style></head>
<body>

<div class="container">
  <h1>üèà Fantasy Football Dashboard V3.4</h1>
  
  <!-- Upload Section -->
  <div class="upload-section">
    <h2>‚öôÔ∏è Configuration</h2>
    <div class="controls">
      <div class="control-group">
        <label>Scoring Format:</label>
        <select id="scoringFormat">
          <option value="PPR">PPR</option>
          <option value="HALF_PPR">Half PPR</option>
          <option value="STANDARD">Standard</option>
        </select>
      </div>
      
      <div class="control-group">
        <label>Sleeper Username:</label>
        <input type="text" id="sleeperUsername" placeholder="username">
      </div>
      
      <div class="control-group">
        <label>League ID:</label>
        <input type="text" id="leagueId" placeholder="123456789">
      </div>
      
      <button onclick="connectToSleeper()" style="align-self: flex-end;">Connect to Sleeper</button>
    </div>
    <div id="statusMessage"></div>
  </div>
  
  <!-- Tab Container -->
  <div class="tab-container">
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('projections')">üìä Projections</button>
      <button class="tab-btn" onclick="switchTab('reliability')">üéØ Reliability</button>
      <button class="tab-btn" onclick="switchTab('rankings')">üìà Rankings</button>
      <button class="tab-btn" onclick="switchTab('waiver')">üî• Waiver Targets</button>
      <button class="tab-btn" onclick="switchTab('lineups')">‚ö° Lineup Optimizer</button>
      <button class="tab-btn" onclick="switchTab('matchups')">‚öîÔ∏è Matchups</button>
      <button class="tab-btn" onclick="switchTab('historical')">üìö Historical</button>
    </div>
    
    <!-- Projections Tab -->
    <div id="projections" class="tab-content active">
      <div class="stats-cards" id="statsCards"></div>
      
      <div class="filters">
        <div class="filter-group">
          <label>Position:</label>
          <select id="posFilter" onchange="renderProjectionsTable()">
            <option value="ALL">All Positions</option>
            <option value="QB">QB</option>
            <option value="RB">RB</option>
            <option value="WR">WR</option>
            <option value="TE">TE</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Roster Filter:</label>
          <select id="rosterFilter" onchange="renderProjectionsTable()">
            <option value="ALL">All Players</option>
            <option value="MY_ROSTER">My Roster</option>
            <option value="AVAILABLE">Available</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Search Player:</label>
          <input type="text" id="searchBox" placeholder="Type name..." oninput="renderProjectionsTable()">
        </div>
      </div>
      
      <div class="table-container">
        <table id="projectionsTable">
          <thead>
            <tr>
              <th>Player</th>
              <th>Pos</th>
              <th>Rank</th>
              <th>Week 8 Proj</th>
              <th>Floor-Ceiling</th>
              <th>Tier</th>
              <th>FP Acc</th>
              <th>Trend</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <!-- Reliability Tab -->
    <div id="reliability" class="tab-content">
      <div class="table-container">
        <table id="reliabilityTable">
          <thead>
            <tr>
              <th class="sortable" onclick="sortReliability('player')">Player</th>
              <th class="sortable" onclick="sortReliability('pos')">Pos</th>
              <th class="sortable" onclick="sortReliability('games')">Games</th>
              <th class="sortable" onclick="sortReliability('correlation')">FP Accuracy</th>
              <th class="sortable" onclick="sortReliability('mae')">MAE</th>
              <th class="sortable" onclick="sortReliability('accuracy')">Within 3pts %</th>
              <th class="sortable" onclick="sortReliability('avgScore')">Avg Score</th>
              <th class="sortable" onclick="sortReliability('avgDiff')">Avg Diff</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <!-- Rankings Tab -->
    <div id="rankings" class="tab-content">
      <div class="position-buttons">
        <button class="pos-btn active" onclick="renderRankingsTable('QB')">QB (Top 30)</button>
        <button class="pos-btn" onclick="renderRankingsTable('RB')">RB (Top 41)</button>
        <button class="pos-btn" onclick="renderRankingsTable('WR')">WR (Top 54)</button>
        <button class="pos-btn" onclick="renderRankingsTable('TE')">TE (Top 26)</button>
      </div>
      
      <div class="table-container">
        <table id="rankingsTable">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Player</th>
              <th>Avg Score</th>
              <th>Games</th>
              <th>FP Acc</th>
              <th>Week 8 Proj</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <!-- Waiver Tab -->
    <div id="waiver" class="tab-content">
      <div class="filters">
        <div class="filter-group">
          <label>Min Projection:</label>
          <input type="number" id="minProj" value="8" step="1" oninput="renderWaiverTable()">
        </div>
        <button onclick="renderWaiverTable()">üîÑ Refresh</button>
      </div>
      
      <div class="table-container">
        <table id="waiverTable">
          <thead>
            <tr>
              <th>Priority</th>
              <th>Player</th>
              <th>Pos</th>
              <th>Week 8 Proj</th>
              <th>Tier</th>
              <th>Trend</th>
              <th>FP Acc</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <!-- Lineups Tab -->
    <div id="lineups" class="tab-content">
      <div class="control-group" style="margin-bottom: 20px;">
        <label>Select Team:</label>
        <select id="teamSelector" style="max-width: 300px;">
          <option value="">Connect to Sleeper first</option>
        </select>
      </div>
      
      <div class="lineup-config">
        <div class="control-group">
          <label>QB:</label>
          <input type="number" id="qbSlots" value="1" min="0" max="3">
        </div>
        <div class="control-group">
          <label>RB:</label>
          <input type="number" id="rbSlots" value="2" min="0" max="4">
        </div>
        <div class="control-group">
          <label>WR:</label>
          <input type="number" id="wrSlots" value="2" min="0" max="4">
        </div>
        <div class="control-group">
          <label>TE:</label>
          <input type="number" id="teSlots" value="1" min="0" max="3">
        </div>
        <div class="control-group">
          <label>FLEX:</label>
          <input type="number" id="flexSlots" value="1" min="0" max="3">
        </div>
      </div>
      
      <button onclick="generateOptimalLineup()">‚ö° Generate Optimal Lineup</button>
      
      <div class="lineup-results" id="lineupResults"></div>
    </div>
    
    <!-- Matchups Tab -->
    <div id="matchups" class="tab-content">
      <div style="text-align: center; padding: 40px; background: rgba(255,255,255,0.05); border-radius: 10px;">
        <h2>‚öîÔ∏è Matchup Simulator</h2>
        <p style="margin-top: 10px; color: #bdc3c7;">Coming soon! Head-to-head matchup analysis and win probability.</p>
      </div>
    </div>
    
    <!-- Historical Tab -->
    <div id="historical" class="tab-content">
      <div id="historicalTables"></div>
    </div>
  </div>
</div>

<script>
// ==================== EMBEDDED DATA ====================
const HISTORICAL_DATA = {"PPR":{"2022":[{"p":"Patrick Mahomes","pos":"QB","w":{"1":25.2,"2":28.4,"3":22.1}},{"p":"Christian McCaffrey","pos":"RB","w":{"1":18.5,"2":22.3,"3":16.8}}],"2023":[{"p":"Patrick Mahomes","pos":"QB","w":{"1":24.8,"2":27.1,"3":21.5}},{"p":"Christian McCaffrey","pos":"RB","w":{"1":20.2,"2":24.1,"3":18.9}}],"2024":[{"p":"Patrick Mahomes","pos":"QB","w":{"1":26.1,"2":29.2,"3":23.4}},{"p":"Christian McCaffrey","pos":"RB","w":{"1":19.8,"2":23.5,"3":17.2}}]},"HALF_PPR":{"2022":[],"2023":[],"2024":[]},"STANDARD":{"2022":[],"2023":[],"2024":[]}};
const SEASON_2025 = {"data":[{"p":"Patrick Mahomes","pos":"QB","w":{"1":25.0,"2":26.5,"3":24.2,"4":28.1,"5":23.8,"6":27.3,"7":25.9}},{"p":"Christian McCaffrey","pos":"RB","w":{"1":21.2,"2":19.8,"3":23.5,"4":20.1,"5":22.4,"6":18.9,"7":21.7}},{"p":"Justin Jefferson","pos":"WR","w":{"1":18.3,"2":22.1,"3":16.8,"4":24.5,"5":19.2,"6":21.6,"7":17.9}},{"p":"Travis Kelce","pos":"TE","w":{"1":14.2,"2":16.8,"3":12.5,"4":18.1,"5":15.3,"6":17.2,"7":13.9}}],"current_week":7};
const WEEKLY_PROJECTIONS = {"1":[{"p":"Patrick Mahomes","pos":"QB","proj":25.0,"best":32.5,"worst":17.5},{"p":"Christian McCaffrey","pos":"RB","proj":21.0,"best":27.3,"worst":14.7}],"2":[{"p":"Patrick Mahomes","pos":"QB","proj":26.5,"best":34.5,"worst":18.6},{"p":"Christian McCaffrey","pos":"RB","proj":20.5,"best":26.7,"worst":14.4}],"3":[{"p":"Patrick Mahomes","pos":"QB","proj":24.0,"best":31.2,"worst":16.8},{"p":"Christian McCaffrey","pos":"RB","proj":22.0,"best":28.6,"worst":15.4}],"4":[{"p":"Patrick Mahomes","pos":"QB","proj":27.5,"best":35.8,"worst":19.3},{"p":"Christian McCaffrey","pos":"RB","proj":21.5,"best":28.0,"worst":15.1}],"5":[{"p":"Patrick Mahomes","pos":"QB","proj":25.5,"best":33.2,"worst":17.9},{"p":"Christian McCaffrey","pos":"RB","proj":22.5,"best":29.3,"worst":15.8}],"6":[{"p":"Patrick Mahomes","pos":"QB","proj":26.0,"best":33.8,"worst":18.2},{"p":"Christian McCaffrey","pos":"RB","proj":20.0,"best":26.0,"worst":14.0}],"7":[{"p":"Patrick Mahomes","pos":"QB","proj":26.5,"best":34.5,"worst":18.6},{"p":"Christian McCaffrey","pos":"RB","proj":21.8,"best":28.3,"worst":15.3}],"8":[{"p":"Patrick Mahomes","pos":"QB","proj":27.0,"best":35.1,"worst":18.9},{"p":"Christian McCaffrey","pos":"RB","proj":22.2,"best":28.9,"worst":15.5},{"p":"Justin Jefferson","pos":"WR","proj":19.5,"best":25.4,"worst":13.7},{"p":"Travis Kelce","pos":"TE","proj":15.8,"best":20.5,"worst":11.1}]};
const CURRENT_WEEK = 7;
const NEXT_WEEK = 8;

// ==================== GLOBAL STATE ====================
let CURRENT_SCORING = 'PPR';
let FP_ACCURACY = {{}};
let PROJECTIONS = [];
let ALL_ROSTERED = new Set();
let USER_ROSTER = [];
let SLEEPER_DATA = null;

// ==================== UTILITY FUNCTIONS ====================
function normalizePlayerName(name) {{
  return name.toLowerCase()
    .replace(/\s+(jr|sr|ii|iii|iv|v)\.?$/i, '')
    .replace(/[^a-z0-9\s]/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}}

function pearsonCorrelation(x, y) {{
  if (x.length !== y.length || x.length === 0) return 0;
  
  const n = x.length;
  const sumX = x.reduce((a, b) => a + b, 0);
  const sumY = y.reduce((a, b) => a + b, 0);
  const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
  const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
  const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
  
  const numerator = n * sumXY - sumX * sumY;
  const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
  
  return denominator === 0 ? 0 : numerator / denominator;
}}

// ==================== CORE CALCULATIONS ====================
function calculateFPAccuracy() {{
  FP_ACCURACY = {{}};
  
  if (!SEASON_2025 || !SEASON_2025.data) return;
  
  const seasonData = SEASON_2025.data;
  const weekNums = Object.keys(WEEKLY_PROJECTIONS).map(Number).sort((a,b) => a-b);
  
  seasonData.forEach(player => {{
    const name = player.p;
    const weeks = player.w;
    const pos = player.pos;
    
    if (!weeks || Object.keys(weeks).length < 3) return;
    
    const projections = [];
    const actuals = [];
    const weekDetails = {{}};
    
    weekNums.forEach(weekNum => {{
      if (weeks[weekNum] !== undefined) {{
        const projData = WEEKLY_PROJECTIONS[weekNum];
        if (projData) {{
          const normName = normalizePlayerName(name);
          const proj = projData.find(p => normalizePlayerName(p.p) === normName);
          
          if (proj && proj.proj > 0) {{
            projections.push(proj.proj);
            actuals.push(weeks[weekNum]);
            weekDetails[weekNum] = {{
              fpProj: proj.proj,
              actual: weeks[weekNum],
              diff: weeks[weekNum] - proj.proj
            }};
          }}
        }}
      }}
    }});
    
    if (projections.length >= 3) {{
      const correlation = pearsonCorrelation(projections, actuals);
      const diffs = projections.map((p, i) => Math.abs(p - actuals[i]));
      const mae = diffs.reduce((a, b) => a + b, 0) / diffs.length;
      const within3 = diffs.filter(d => d <= 3).length / diffs.length;
      const avgDiff = projections.reduce((sum, p, i) => sum + (actuals[i] - p), 0) / projections.length;
      
      FP_ACCURACY[name] = {{
        position: pos,
        games: projections.length,
        weeks: weekDetails,
        correlation: correlation,
        mae: mae,
        accuracy: within3,
        avgDiff: avgDiff
      }};
    }}
  }});
  
  console.log(`FP Accuracy calculated for ${{Object.keys(FP_ACCURACY).length}} players`);
}}

function calculateProjections() {{
  if (!SEASON_2025 || !SEASON_2025.data) return [];
  
  const projections = [];
  const nextWeekProj = WEEKLY_PROJECTIONS[NEXT_WEEK] || [];
  
  SEASON_2025.data.forEach(player => {{
    const name = player.p;
    const pos = player.pos;
    const weeks = player.w;
    
    if (!weeks || Object.keys(weeks).length === 0) return;
    
    const scores = Object.values(weeks);
    const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;
    const games = scores.length;
    
    // Find FP projection
    const normName = normalizePlayerName(name);
    const fpProj = nextWeekProj.find(p => normalizePlayerName(p.p) === normName);
    
    let proj = avgScore;
    let floor = avgScore * 0.7;
    let ceiling = avgScore * 1.3;
    let hasFP = false;
    
    if (fpProj && fpProj.proj > 0) {{
      proj = fpProj.proj;
      floor = fpProj.worst || fpProj.proj * 0.7;
      ceiling = fpProj.best || fpProj.proj * 1.3;
      hasFP = true;
      
      // Apply correlation adjustment
      const accuracy = FP_ACCURACY[name];
      if (accuracy && accuracy.correlation > 0.5) {{
        const blend = 0.7 * proj + 0.3 * avgScore;
        proj = blend;
      }}
    }}
    
    projections.push({{
      p: name,
      pos: pos,
      proj: proj,
      floor: floor,
      ceiling: ceiling,
      avgScore: avgScore,
      games: games,
      hasFP: hasFP,
      correlation: FP_ACCURACY[name]?.correlation || 0,
      mae: FP_ACCURACY[name]?.mae || 0,
      avgDiff: FP_ACCURACY[name]?.avgDiff || 0
    }});
  }});
  
  // Sort by projection
  projections.sort((a, b) => b.proj - a.proj);
  
  // Assign ranks and tiers
  const posCounts = {{ QB: 0, RB: 0, WR: 0, TE: 0 }};
  projections.forEach(p => {{
    posCounts[p.pos]++;
    p.rank = posCounts[p.pos];
    
    // Assign tier based on rank
    const rank = p.rank;
    if (p.pos === 'QB') {{
      if (rank <= 6) p.tier = 'Elite';
      else if (rank <= 12) p.tier = 'High';
      else if (rank <= 24) p.tier = 'Mid';
      else p.tier = 'Stream';
    }} else if (p.pos === 'RB') {{
      if (rank <= 12) p.tier = 'Elite';
      else if (rank <= 24) p.tier = 'High';
      else if (rank <= 36) p.tier = 'Mid';
      else p.tier = 'Stream';
    }} else if (p.pos === 'WR') {{
      if (rank <= 12) p.tier = 'Elite';
      else if (rank <= 24) p.tier = 'High';
      else if (rank <= 36) p.tier = 'Mid';
      else p.tier = 'Stream';
    }} else if (p.pos === 'TE') {{
      if (rank <= 6) p.tier = 'Elite';
      else if (rank <= 12) p.tier = 'High';
      else if (rank <= 20) p.tier = 'Mid';
      else p.tier = 'Stream';
    }}
  }});
  
  return projections;
}}

// ==================== RENDERING FUNCTIONS ====================
function updateMetrics() {{
  const cards = [
    {{ label: 'Total Players', value: PROJECTIONS.length }},
    {{ label: 'With FP Data', value: PROJECTIONS.filter(p => p.hasFP).length }},
    {{ label: 'High Accuracy', value: Object.values(FP_ACCURACY).filter(a => a.correlation > 0.7).length }},
    {{ label: 'My Roster', value: USER_ROSTER.length }},
    {{ label: 'Available', value: PROJECTIONS.filter(p => !isRostered(p.p)).length }}
  ];
  
  const html = cards.map(card => `
    <div class="stat-card">
      <h3>${{card.label}}</h3>
      <div class="value">${{card.value}}</div>
    </div>
  `).join('');
  
  document.getElementById('statsCards').innerHTML = html;
}}

function renderProjectionsTable() {{
  const posFilter = document.getElementById('posFilter').value;
  const rosterFilter = document.getElementById('rosterFilter').value;
  const searchTerm = document.getElementById('searchBox').value.toLowerCase();
  
  let filtered = PROJECTIONS.filter(p => {{
    if (posFilter !== 'ALL' && p.pos !== posFilter) return false;
    if (rosterFilter === 'MY_ROSTER' && !isOnRoster(p.p)) return false;
    if (rosterFilter === 'AVAILABLE' && isRostered(p.p)) return false;
    if (searchTerm && !p.p.toLowerCase().includes(searchTerm)) return false;
    return true;
  }});
  
  const tbody = document.getElementById('projectionsTable').querySelector('tbody');
  tbody.innerHTML = filtered.map(p => {{
    const trend = p.avgDiff > 2 ? 'üìà' : p.avgDiff < -2 ? 'üìâ' : '‚û°Ô∏è';
    const trendClass = p.avgDiff > 2 ? 'trend-up' : p.avgDiff < -2 ? 'trend-down' : 'trend-stable';
    const roster = isOnRoster(p.p) ? 'üè†' : '';
    const rowClass = isOnRoster(p.p) ? 'my-roster' : isRostered(p.p) ? 'rostered' : '';
    
    return `
      <tr class="pos-${{p.pos}} ${{rowClass}}">
        <td>${{roster}} ${{p.p}}</td>
        <td>${{p.pos}}</td>
        <td>${{p.rank}}</td>
        <td><strong>${{p.proj.toFixed(1)}}</strong></td>
        <td>${{p.floor.toFixed(1)}} - ${{p.ceiling.toFixed(1)}}</td>
        <td><span class="badge ${{p.tier.toLowerCase()}}">${{p.tier}}</span></td>
        <td>${{(p.correlation * 100).toFixed(0)}}%</td>
        <td class="${{trendClass}}">${{trend}}</td>
      </tr>
    `;
  }}).join('');
}}

function renderReliabilityTable() {{
  const data = Object.entries(FP_ACCURACY)
    .filter(([name, stats]) => stats.games >= 3)
    .map(([name, stats]) => ({{ name, ...stats }}))
    .sort((a, b) => b.correlation - a.correlation);
  
  const tbody = document.getElementById('reliabilityTable').querySelector('tbody');
  tbody.innerHTML = data.map(p => {{
    const avgScoreWeeks = Object.values(p.weeks).map(w => w.actual);
    const avgScore = avgScoreWeeks.reduce((a,b) => a+b, 0) / avgScoreWeeks.length;
    const diffClass = p.avgDiff > 0 ? 'trend-up' : p.avgDiff < 0 ? 'trend-down' : 'trend-stable';
    
    return `
      <tr class="pos-${{p.position}}">
        <td>${{p.name}}</td>
        <td>${{p.position}}</td>
        <td>${{p.games}}</td>
        <td><strong>${{(p.correlation * 100).toFixed(0)}}%</strong></td>
        <td>${{p.mae.toFixed(2)}}</td>
        <td>${{(p.accuracy * 100).toFixed(0)}}%</td>
        <td>${{avgScore.toFixed(1)}}</td>
        <td class="${{diffClass}}">${{p.avgDiff > 0 ? '+' : ''}}${{p.avgDiff.toFixed(1)}}</td>
      </tr>
    `;
  }}).join('');
}}

function renderRankingsTable(position) {{
  // Update button states
  document.querySelectorAll('.pos-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  const limits = {{ QB: 30, RB: 41, WR: 54, TE: 26 }};
  const limit = limits[position] || 30;
  
  const filtered = PROJECTIONS
    .filter(p => p.pos === position)
    .slice(0, limit);
  
  const tbody = document.getElementById('rankingsTable').querySelector('tbody');
  tbody.innerHTML = filtered.map(p => `
    <tr class="pos-${{p.pos}}">
      <td><strong>${{p.rank}}</strong></td>
      <td>${{p.p}}</td>
      <td>${{p.avgScore.toFixed(1)}}</td>
      <td>${{p.games}}</td>
      <td>${{(p.correlation * 100).toFixed(0)}}%</td>
      <td><strong>${{p.proj.toFixed(1)}}</strong></td>
    </tr>
  `).join('');
}}

function renderWaiverTable() {{
  const minProj = parseFloat(document.getElementById('minProj').value) || 0;
  
  const available = PROJECTIONS
    .filter(p => !isRostered(p.p) && p.proj >= minProj)
    .sort((a, b) => b.proj - a.proj)
    .slice(0, 30);
  
  const tbody = document.getElementById('waiverTable').querySelector('tbody');
  tbody.innerHTML = available.map((p, idx) => {{
    const priority = idx < 5 ? 'üî•' : idx < 15 ? '‚≠ê' : 'üëÄ';
    const priorityClass = idx < 5 ? 'priority-hot' : idx < 15 ? 'priority-star' : 'priority-watch';
    const trend = p.avgDiff > 2 ? 'üìà' : p.avgDiff < -2 ? 'üìâ' : '‚û°Ô∏è';
    const trendClass = p.avgDiff > 2 ? 'trend-up' : p.avgDiff < -2 ? 'trend-down' : 'trend-stable';
    
    return `
      <tr class="pos-${{p.pos}}">
        <td class="${{priorityClass}}">${{priority}}</td>
        <td><strong>${{p.p}}</strong></td>
        <td>${{p.pos}}</td>
        <td><strong>${{p.proj.toFixed(1)}}</strong></td>
        <td><span class="badge ${{p.tier.toLowerCase()}}">${{p.tier}}</span></td>
        <td class="${{trendClass}}">${{trend}}</td>
        <td>${{(p.correlation * 100).toFixed(0)}}%</td>
      </tr>
    `;
  }}).join('');
}}

function renderHistoricalTable() {{
  const positions = ['QB', 'RB', 'WR', 'TE'];
  const container = document.getElementById('historicalTables');
  
  const html = positions.map(pos => {{
    const posData = {{}};
    
    // Calculate averages for each rank across years
    ['2022', '2023', '2024'].forEach(year => {{
      const yearData = HISTORICAL_DATA[CURRENT_SCORING][year] || [];
      const posPlayers = yearData.filter(p => p.pos === pos);
      
      posPlayers.forEach((player, idx) => {{
        const rank = idx + 1;
        if (rank > 24) return;
        
        const weeks = Object.values(player.w);
        if (weeks.length === 0) return;
        
        const avg = weeks.reduce((a, b) => a + b, 0) / weeks.length;
        
        if (!posData[rank]) posData[rank] = {{}};
        posData[rank][year] = avg;
      }});
    }});
    
    // Calculate 3-year averages
    const rows = Object.entries(posData)
      .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))
      .map(([rank, years]) => {{
        const vals = Object.values(years);
        const avg3yr = vals.length > 0 ? vals.reduce((a,b) => a+b, 0) / vals.length : 0;
        
        return `
          <tr class="pos-${{pos}}">
            <td><strong>${{rank}}</strong></td>
            <td>${{years['2022']?.toFixed(1) || '-'}}</td>
            <td>${{years['2023']?.toFixed(1) || '-'}}</td>
            <td>${{years['2024']?.toFixed(1) || '-'}}</td>
            <td><strong>${{avg3yr.toFixed(1)}}</strong></td>
          </tr>
        `;
      }}).join('');
    
    return `
      <div class="historical-section">
        <h3>${{pos}} Historical Averages (Top 24)</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>2022</th>
                <th>2023</th>
                <th>2024</th>
                <th>3-Yr Avg</th>
              </tr>
            </thead>
            <tbody>${{rows}}</tbody>
          </table>
        </div>
      </div>
    `;
  }}).join('');
  
  container.innerHTML = html;
}}

// ==================== SLEEPER INTEGRATION ====================
async function connectToSleeper() {{
  const username = document.getElementById('sleeperUsername').value.trim();
  const leagueId = document.getElementById('leagueId').value.trim();
  const statusDiv = document.getElementById('statusMessage');
  
  if (!username || !leagueId) {{
    statusDiv.innerHTML = '<div class="status error">Please enter both username and league ID</div>';
    return;
  }}
  
  statusDiv.innerHTML = '<div class="status">Connecting to Sleeper...</div>';
  
  try {{
    // Fetch user
    const userRes = await fetch(`https://api.sleeper.app/v1/user/${{username}}`);
    if (!userRes.ok) throw new Error('User not found');
    const userData = await userRes.json();
    
    // Fetch rosters
    const rostersRes = await fetch(`https://api.sleeper.app/v1/league/${{leagueId}}/rosters`);
    if (!rostersRes.ok) throw new Error('League not found');
    const rosters = await rostersRes.json();
    
    // Fetch users
    const usersRes = await fetch(`https://api.sleeper.app/v1/league/${{leagueId}}/users`);
    const users = await usersRes.json();
    
    // Fetch NFL players
    const playersRes = await fetch('https://api.sleeper.app/v1/players/nfl');
    const allPlayers = await playersRes.json();
    
    // Build rostered sets
    ALL_ROSTERED.clear();
    rosters.forEach(roster => {{
      (roster.players || []).forEach(pid => ALL_ROSTERED.add(pid));
    }});
    
    // Find my roster
    const myRoster = rosters.find(r => r.owner_id === userData.user_id);
    if (!myRoster) throw new Error('You are not in this league');
    
    USER_ROSTER = (myRoster.players || []).map(pid => {{
      const p = allPlayers[pid];
      return p ? p.full_name : null;
    }}).filter(Boolean);
    
    // Store data
    SLEEPER_DATA = {{ rosters, users, players: allPlayers, myRoster }};
    
    // Populate team selector
    populateTeamSelector(rosters, users);
    
    statusDiv.innerHTML = `<div class="status success">‚úÖ Connected! Found ${{USER_ROSTER.length}} players on your roster</div>`;
    
    // Re-render tables
    updateMetrics();
    renderProjectionsTable();
    renderWaiverTable();
    
  }} catch (error) {{
    statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${{error.message}}</div>`;
  }}
}}

function populateTeamSelector(rosters, users) {{
  const selector = document.getElementById('teamSelector');
  selector.innerHTML = rosters.map((roster, idx) => {{
    const user = users.find(u => u.user_id === roster.owner_id);
    const name = user ? user.display_name : `Team ${{idx + 1}}`;
    return `<option value="${{idx}}">${{name}}</option>`;
  }}).join('');
}}

function isOnRoster(playerName) {{
  const norm = normalizePlayerName(playerName);
  return USER_ROSTER.some(rp => normalizePlayerName(rp) === norm);
}}

function isRostered(playerName) {{
  if (!SLEEPER_DATA) return false;
  
  const norm = normalizePlayerName(playerName);
  const players = SLEEPER_DATA.players;
  
  for (const [pid, player] of Object.entries(players)) {{
    if (player.full_name && normalizePlayerName(player.full_name) === norm) {{
      return ALL_ROSTERED.has(pid);
    }}
  }}
  
  return false;
}}

// ==================== LINEUP OPTIMIZER ====================
function generateOptimalLineup() {{
  const teamIdx = parseInt(document.getElementById('teamSelector').value);
  if (isNaN(teamIdx) || !SLEEPER_DATA) {{
    alert('Please connect to Sleeper first');
    return;
  }}
  
  const roster = SLEEPER_DATA.rosters[teamIdx];
  const players = SLEEPER_DATA.players;
  
  // Get roster players with projections
  const rosterPlayers = (roster.players || []).map(pid => {{
    const p = players[pid];
    if (!p || !p.full_name) return null;
    
    const proj = PROJECTIONS.find(pr => normalizePlayerName(pr.p) === normalizePlayerName(p.full_name));
    return proj ? {{ ...proj, sleeperPos: p.position }} : null;
  }}).filter(Boolean);
  
  // Get slot counts
  const qbSlots = parseInt(document.getElementById('qbSlots').value) || 0;
  const rbSlots = parseInt(document.getElementById('rbSlots').value) || 0;
  const wrSlots = parseInt(document.getElementById('wrSlots').value) || 0;
  const teSlots = parseInt(document.getElementById('teSlots').value) || 0;
  const flexSlots = parseInt(document.getElementById('flexSlots').value) || 0;
  
  // Separate by position
  const byPos = {{
    QB: rosterPlayers.filter(p => p.pos === 'QB').sort((a,b) => b.proj - a.proj),
    RB: rosterPlayers.filter(p => p.pos === 'RB').sort((a,b) => b.proj - a.proj),
    WR: rosterPlayers.filter(p => p.pos === 'WR').sort((a,b) => b.proj - a.proj),
    TE: rosterPlayers.filter(p => p.pos === 'TE').sort((a,b) => b.proj - a.proj)
  }};
  
  // Fill starters
  const starters = {{
    QB: byPos.QB.slice(0, qbSlots),
    RB: byPos.RB.slice(0, rbSlots),
    WR: byPos.WR.slice(0, wrSlots),
    TE: byPos.TE.slice(0, teSlots),
    FLEX: []
  }};
  
  // Fill FLEX with best remaining
  const flexPool = [
    ...byPos.RB.slice(rbSlots),
    ...byPos.WR.slice(wrSlots),
    ...byPos.TE.slice(teSlots)
  ].sort((a,b) => b.proj - a.proj);
  
  starters.FLEX = flexPool.slice(0, flexSlots);
  
  // Calculate total
  const allStarters = [...starters.QB, ...starters.RB, ...starters.WR, ...starters.TE, ...starters.FLEX];
  const totalProj = allStarters.reduce((sum, p) => sum + p.proj, 0);
  const totalFloor = allStarters.reduce((sum, p) => sum + p.floor, 0);
  const totalCeiling = allStarters.reduce((sum, p) => sum + p.ceiling, 0);
  
  // Get bench
  const starterNames = new Set(allStarters.map(p => p.p));
  const bench = rosterPlayers.filter(p => !starterNames.has(p.p));
  
  // Render results
  const resultsDiv = document.getElementById('lineupResults');
  
  const startersHtml = Object.entries(starters).map(([pos, players]) => {{
    if (players.length === 0) return '';
    
    return `
      <div class="starter-card pos-${{pos}}">
        <h4>${{pos}}</h4>
        ${{players.map(p => `
          <div style="margin-top: 8px;">
            <strong>${{p.p}}</strong><br>
            <span style="font-size: 0.9em;">
              Proj: ${{p.proj.toFixed(1)}} (${{p.floor.toFixed(1)}}-${{p.ceiling.toFixed(1)}})
            </span>
          </div>
        `).join('')}}
      </div>
    `;
  }}).join('');
  
  const benchHtml = bench.map(p => `
    <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px; border-left: 3px solid #95a5a6;">
      <strong>${{p.p}}</strong> (${{p.pos}}) - ${{p.proj.toFixed(1)}}
    </div>
  `).join('');
  
  resultsDiv.innerHTML = `
    <div style="background: rgba(52,152,219,0.2); border: 2px solid #3498db; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
      <h3>üìä Total Projection</h3>
      <div style="font-size: 2em; font-weight: bold; color: #3498db;">${{totalProj.toFixed(1)}}</div>
      <div style="margin-top: 5px; color: #bdc3c7;">Range: ${{totalFloor.toFixed(1)}} - ${{totalCeiling.toFixed(1)}}</div>
    </div>
    
    <h3 style="margin-bottom: 15px;">‚ö° Starters</h3>
    <div class="starters-grid">${{startersHtml}}</div>
    
    <div class="bench-section">
      <h3>üí∫ Bench (${{bench.length}})</h3>
      <div class="bench-list">${{benchHtml || '<p style="color: #95a5a6;">No bench players</p>'}}</div>
    </div>
  `;
}}

// ==================== TAB SWITCHING ====================
function switchTab(tabName) {{
  // Update buttons
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Update content
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
}}

// ==================== SORTING ====================
let sortColumn = 'correlation';
let sortDirection = 'desc';

function sortReliability(column) {{
  if (sortColumn === column) {{
    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
  }} else {{
    sortColumn = column;
    sortDirection = 'desc';
  }}
  
  // Update header classes
  document.querySelectorAll('#reliabilityTable th').forEach(th => {{
    th.classList.remove('sort-asc', 'sort-desc');
  }});
  
  const th = event.target;
  th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
  
  renderReliabilityTable();
}}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {{
  console.log('üèà Fantasy Dashboard V3.4 Loaded');
  console.log('Data:', {{
    historical: Object.keys(HISTORICAL_DATA.PPR).length,
    season: SEASON_2025.data.length,
    projections: Object.keys(WEEKLY_PROJECTIONS).length
  }});
  
  // Calculate everything
  calculateFPAccuracy();
  PROJECTIONS = calculateProjections();
  
  // Initial render
  updateMetrics();
  renderProjectionsTable();
  renderReliabilityTable();
  renderRankingsTable('QB');
  renderWaiverTable();
  renderHistoricalTable();
  
  console.log('‚úÖ Dashboard ready!');
}});

// Scoring format change handler
document.getElementById('scoringFormat').addEventListener('change', (e) => {{
  CURRENT_SCORING = e.target.value;
  console.log('Switched to', CURRENT_SCORING);
  
  // Recalculate with new scoring
  calculateFPAccuracy();
  PROJECTIONS = calculateProjections();
  
  // Re-render everything
  updateMetrics();
  renderProjectionsTable();
  renderReliabilityTable();
  renderRankingsTable('QB');
  renderWaiverTable();
  renderHistoricalTable();
}});
</script>

</body>
</html>